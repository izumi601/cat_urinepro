<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± çŒ«ã®å¥åº·ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { 
            text-align: center; 
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .upload-section { 
            margin-bottom: 30px; 
            padding: 25px; 
            border: 2px dashed #667eea;
            border-radius: 12px;
            background: #f8f9ff;
            transition: all 0.3s;
        }
        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }
        .upload-section h2 {
            margin-top: 0;
            color: #667eea;
        }
        input[type="file"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin-left: 10px;
        }
        #data-status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 600;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .chart-container { 
            margin-top: 30px; 
            padding: 20px; 
            border-radius: 12px;
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-container h3 {
            color: #333;
            margin-top: 0;
        }
        canvas {
            background: white;
            border-radius: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .info-box strong {
            color: #667eea;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ± çŒ«ã®ãŠã—ã£ã“ç”»åƒè§£æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p class="subtitle">Python + OpenCV ã«ã‚ˆã‚‹ç”»åƒè§£æ</p>

        <div class="info-box">
            <strong>ğŸ“Œ ä½¿ã„æ–¹:</strong> 100å††ç‰ã¨ä¸€ç·’ã«æ’®å½±ã—ãŸãŠã—ã£ã“ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
            100å††ç‰ã‚’ã‚¹ã‚±ãƒ¼ãƒ«åŸºæº–ã¨ã—ã¦ã€æ­£ç¢ºãªæ’å°¿é‡ï¼ˆmmÂ²ï¼‰ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚
        </div>
        <div class="info-box" style="border-left: 4px solid #f5576c; background: #fff8f8;">
            <strong>ğŸŒŸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦ã¨ç›®çš„</strong>
            <p style="margin-top: 5px; color: #333;">
                ã“ã®ã‚¢ãƒ—ãƒªã¯ã€**çŒ«ã®æ³Œå°¿å™¨ç³»ãƒˆãƒ©ãƒ–ãƒ«ï¼ˆè…è‡“ç—…ã€å°¿çŸ³ç—‡ãªã©ï¼‰**ã®**æ—©æœŸç™ºè¦‹**ã‚’ç›®çš„ã¨ã—ãŸå¥åº·ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã™ã€‚
                æ—¥ã€…ã®**æ’å°¿é‡ã¨å°¿ã®æ¿ƒæ·¡**ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±è¨ˆçš„ã«åˆ†æã—ã€ãã®çŒ«è‡ªèº«ã®ç•°å¸¸å€¤ã‹ã‚‰ã®å¤‰åŒ–ã‚’è¦‹æŠœãã¾ã™ã€‚
            </p>
        </div>

        <div class="info-box" style="border-left: 4px solid #764ba2; background: #f8f9ff;">
            <strong>ğŸ§  æŠ€è¡“çš„ãƒã‚¤ãƒ©ã‚¤ãƒˆ (ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ)</strong>
            <ul style="padding-left: 20px; margin-top: 5px; color: #333;">
                <li>**é«˜ç²¾åº¦ãªç”»åƒè§£æ (OpenCV)**: 100å††ç‰ã‚’æ¤œå‡ºã—ã€mmÂ²å˜ä½ã§æ’å°¿é‡ã‚’æ­£ç¢ºã«ç®—å‡ºã€‚</li>
                <li>**çµ±è¨ˆçš„ç•°å¸¸æ¤œçŸ¥ (NumPy)**: Zã‚¹ã‚³ã‚¢æ³• (<span style="font-style: italic;">&mu;</span> Â± 2<span style="font-style: italic;">&sigma;</span>) ã‚’ç”¨ã„ã€çŒ«å€‹ä½“ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã«åŸºã¥ãæ’å°¿é‡ã¨æ¿ƒæ·¡ã®ç•°å¸¸å€¤ã‚’åˆ¤å®šã€‚</li>
                <li>**ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯é–‹ç™º**: Python/Flask (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰)ã€SQLite (DB)ã€Chart.js (å¯è¦–åŒ–) ã‚’çµ„ã¿åˆã‚ã›ãŸæ§‹æˆã€‚</li>
            </ul>
        </div>
        <div class="note-box" style="margin-top: 20px; border: 1px solid #ffcc00; padding: 15px; background: #fffde7;">
            <h4>ãƒ‡ãƒ¼ã‚¿ã®å“è³ªç®¡ç†ï¼ˆã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰</h4>
            <p>ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã€ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç¢ºèªã•ã‚ŒãŸä»¥ä¸‹3ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é™¤å¤–ã—ãŸ**18ä»¶**ã®ã‚¯ãƒªãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚ è¨ˆæ¸¬æœŸé–“: 2025/09/06 - 09/27ï¼ˆ21æ—¥é–“ï¼‰</p>
            <ul>
                <li><strong>Day1</strong>: æ¸¬å®šã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã«ã‚ˆã‚Šé™¤å¤–</li>
                <li><strong>Day16</strong>: æ¸¬å®šã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã«ã‚ˆã‚Šé™¤å¤–</li>
                <li><strong>Day21</strong>: æ¸¬å®šã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã«ã‚ˆã‚Šé™¤å¤–</li>
            </ul>
        </div>
        <div class="upload-section">
            <h2>ğŸ“· æ–°è¦ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <form id="uploadForm">
                <input type="file" id="fileInput" name="file" accept="image/*" required>
                <button type="submit" id="uploadBtn">è§£æã—ã¦è¿½åŠ </button>
                <button type="button" class="btn-danger" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
            </form>
        </div>

        <div id="data-status" class="status-warning">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

        <div class="stats-grid" id="statsGrid" style="display:none;">
            <div class="stat-card">
                <div class="stat-label">è¨˜éŒ²æ•°</div>
                <div class="stat-value" id="totalRecords">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡æ’å°¿é‡</div>
                <div class="stat-value" id="avgArea">-</div>
                <div class="stat-label">mmÂ²</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡æ¿ƒåº¦ï¼ˆLå€¤ï¼‰</div>
                <div class="stat-value" id="avgL">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡æ¨™æº–åå·®</div>
                <div class="stat-value" id="avgStd">-</div>
            </div>
        </div>

        <div class="chart-container">
            <h3>ğŸ“Š æ’å°¿é‡ (mmÂ²) ã®æ¨ç§»</h3>
            <canvas id="areaChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>ğŸ“Š æ¿ƒæ·¡ (å¹³å‡Lå€¤) ã®æ¨ç§»</h3>
            <canvas id="lValueChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>ğŸ“Š æ¿ƒæ·¡ã®å®‰å®šæ€§ (Lå€¤æ¨™æº–åå·®) ã®æ¨ç§»</h3>
            <canvas id="stdChart"></canvas>
        </div>
    </div>

    <script>
        // index.html ã® <script> ã‚¿ã‚°å†…ã®ä¿®æ­£ã‚³ãƒ¼ãƒ‰

let chartInstances = {};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
document.addEventListener('DOMContentLoaded', () => {
    fetchData();
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await uploadImage();
    });
});

// ãƒ‡ãƒ¼ã‚¿å–å¾—
async function fetchData() {
    try {
        const response = await fetch('/api/data');
        const data = await response.json();

        // ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ãŸå ´åˆã®ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€é‡è¦ï¼‰
        if (!Array.isArray(data)) {
             // data.map is not a function ã‚¨ãƒ©ãƒ¼ã¯ã“ã“ã§ç™ºç”Ÿã—ã¦ã„ãŸå¯èƒ½æ€§ãŒé«˜ã„
            const errorMessage = data.error || 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é…åˆ—ã§ã¯ãªã„ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚';
            throw new Error(errorMessage);
        }

        if (data.length === 0) {
            showStatus('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'warning');
            document.getElementById('statsGrid').style.display = 'none';
            return;
        }

        showStatus(`âœ… éå» ${data.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
        updateDisplay(data);
        updateStats(); // çµ±è¨ˆæƒ…å ±ã¯åˆ¥é€”APIã‚’å©ã

    } catch (error) {
        // Renderã®èµ·å‹•æ™‚ã®ã‚¨ãƒ©ãƒ¼ãŒã“ã“ã‚’é€šã‚‹å¯èƒ½æ€§ãŒé«˜ã„
        const displayMessage = error.message.includes("Failed to fetch") 
            ? "âŒ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¸­/ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚" 
            : 'âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message;
        
        showStatus(displayMessage, 'error');
        console.error('Error fetching data:', error);
    }
}

// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
async function uploadImage() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    const uploadBtn = document.getElementById('uploadBtn');

    if (!file) {
        showStatus('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="spinner"></span> è§£æä¸­...';
    showStatus('â³ ç”»åƒã‚’è§£æä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„', 'info');

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
        const result = await response.json();

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¨ãƒ©ãƒ¼å¿œç­”ãŒè¿”ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
        if (response.status !== 200 || result.error) {
            // ã‚¨ãƒ©ãƒ¼ã¯ /upload ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚µãƒ¼ãƒãƒ¼å´ã§ç™ºç”Ÿ
            throw new Error(result.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // æˆåŠŸã—ãŸå ´åˆ
        showStatus('âœ… è§£æå®Œäº†ï¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        fileInput.value = '';
        fetchData(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿

    } catch (error) {
        showStatus('âŒ ' + error.message, 'error');
        console.error('Upload error:', error);
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'è§£æã—ã¦è¿½åŠ ';
    }
}

// è¡¨ç¤ºæ›´æ–°
function updateDisplay(data) {
    document.getElementById('statsGrid').style.display = 'grid';

    // day_idã§ã¯ãªãã€ã‚·ãƒ³ãƒ—ãƒ«ãªé€£ç•ªã‚’ãƒ©ãƒ™ãƒ«ã«ä½¿ã†ã“ã¨ã§è¦–èªæ€§ã‚’é«˜ã‚ã‚‹
    const labels = data.map((d, i) => `Day ${i + 1}`); 
    const areaData = data.map(d => d.area_mm2);
    const lData = data.map(d => d.avg_l_value);
    const stdData = data.map(d => d.std_l_value);

    drawChart('areaChart', labels, areaData, 'æ’å°¿é‡ (mmÂ²)', 'rgba(54, 162, 235, 1)');
    drawChart('lValueChart', labels, lData, 'æ¿ƒæ·¡ (å¹³å‡Lå€¤)', 'rgba(75, 192, 192, 1)');
    drawChart('stdChart', labels, stdData, 'æ¿ƒæ·¡ã®å®‰å®šæ€§ (æ¨™æº–åå·®)', 'rgba(255, 99, 132, 1)');
}


// çµ±è¨ˆæ›´æ–° (ã“ã®é–¢æ•°ã¯ /api/stats ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™)
async function updateStats() {
    // çµ±è¨ˆAPIãŒæœªå®Ÿè£…ã®å ´åˆã€ã“ã®é–¢æ•°ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚æ³¨æ„
    try {
        const response = await fetch('/api/data'); // /api/statsãŒãªã„ãŸã‚ã€/api/dataã‹ã‚‰çµ±è¨ˆã‚’è¨ˆç®—
        const data = await response.json();
        
        if (!Array.isArray(data) || data.length === 0) return;

        const areaValues = data.map(d => d.area_mm2).filter(v => v !== null);
        const lValues = data.map(d => d.avg_l_value).filter(v => v !== null);
        const stdValues = data.map(d => d.std_l_value).filter(v => v !== null);

        const sum = (arr) => arr.reduce((a, b) => a + b, 0);
        const avg = (arr) => arr.length ? (sum(arr) / arr.length).toFixed(2) : '-';

        document.getElementById('totalRecords').textContent = data.length;
        document.getElementById('avgArea').textContent = avg(areaValues);
        document.getElementById('avgL').textContent = avg(lValues);
        document.getElementById('avgStd').textContent = avg(stdValues);

    } catch (error) {
        console.error('Stats update error:', error);
    }
}

// ã‚°ãƒ©ãƒ•æç”»
function drawChart(canvasId, labels, data, label, color) {
    const ctx = document.getElementById(canvasId);

    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }
    // ... (ä»¥ä¸‹ã€drawCharté–¢æ•°ã®æœ¬ä½“ã¯å¤‰æ›´ãªã—) ...
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: color.replace('1)', '0.1)'),
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
function showStatus(message, type) {
    const statusDiv = document.getElementById('data-status');
    statusDiv.textContent = message;
    statusDiv.className = `status-${type}`;
}

// å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ (ã‚µãƒ¼ãƒãƒ¼å´ã«ã‚‚ /api/clear ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã§ã™)
async function clearAllData() {
    if (!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch('/api/clear', {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showStatus('âœ… ' + result.message, 'success');
            fetchData();
        } else {
            showStatus('âŒ ' + (result.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'), 'error');
        }
    } catch (error) {
        showStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    }
}
    </script>
</body>
</html>